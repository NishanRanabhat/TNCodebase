<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNCodebase Config Builder</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .container {
            display: flex;
            gap: 30px;
        }
        .form-container {
            flex: 1;
            min-width: 500px;
        }
        .preview-container {
            flex: 1;
            min-width: 400px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a90d9;
            color: #4a90d9;
            font-size: 1.2em;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 0 2px rgba(74,144,217,0.2);
        }
        .form-group small {
            color: #888;
            font-size: 12px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .hidden {
            display: none !important;
        }
        #json-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
            max-height: 70vh;
            overflow-y: auto;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #4a90d9;
            color: white;
        }
        .btn-primary:hover {
            background: #3a7bc8;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .preview-header h2 {
            margin: 0;
            color: #333;
        }
        .info-text {
            background: #e7f3ff;
            border-left: 4px solid #4a90d9;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #333;
        }
        .subsection {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        .subsection h3 {
            margin-top: 0;
            font-size: 1em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>TNCodebase Config Builder</h1>
    
    <div class="container">
        <div class="form-container">
            <!-- SYSTEM SECTION -->
            <div class="section">
                <h2>System</h2>
                <div class="form-group">
                    <label>System Type</label>
                    <select id="system-type" onchange="onSystemTypeChange()">
                        <option value="spin">Spin</option>
                        <option value="spinboson">Spin-Boson</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group" id="group-N">
                        <label>N (number of sites)</label>
                        <input type="number" id="system-N" value="20" min="3" onchange="validateNexp(); updatePreview()">
                    </div>
                    <div class="form-group hidden" id="group-N_spins">
                        <label>N_spins (number of spins)</label>
                        <input type="number" id="system-N_spins" value="20" min="1" onchange="validateNexp(); updatePreview()">
                    </div>
                    <div class="form-group">
                        <label>S (spin quantum number)</label>
                        <select id="system-S" onchange="onSpinChange()">
                            <option value="0.5">0.5 (d=2)</option>
                            <option value="1.0">1.0 (d=3)</option>
                            <option value="1.5">1.5 (d=4)</option>
                            <option value="2.0">2.0 (d=5)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group hidden" id="group-nmax">
                    <label>nmax (boson truncation)</label>
                    <input type="number" id="system-nmax" value="5" min="1" onchange="onNmaxChange()">
                    <small>Fock states: 0, 1, 2, ..., nmax</small>
                </div>
            </div>

            <!-- MODEL SECTION -->
            <div class="section">
                <h2>Model</h2>
                <div class="form-group">
                    <label>Model Name</label>
                    <select id="model-name" onchange="onModelChange()">
                        <optgroup label="Spin Models" id="spin-models">
                            <option value="transverse_field_ising">Transverse Field Ising</option>
                            <option value="heisenberg">Heisenberg</option>
                            <option value="long_range_ising">Long-Range Ising</option>
                        </optgroup>
                        <optgroup label="Spin-Boson Models" id="spinboson-models" class="hidden">
                            <option value="ising_dickie">Ising-Dicke</option>
                            <option value="long_range_ising_dickie">Long-Range Ising-Dicke</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>dtype (data type)</label>
                    <select id="model-dtype" onchange="updatePreview()">
                        <option value="Float64">Float64</option>
                        <option value="ComplexF64">ComplexF64</option>
                    </select>
                    <small>Use ComplexF64 if model contains Y, Sp, or Sm operators</small>
                </div>

                <!-- TFIM params -->
                <div id="params-transverse_field_ising" class="subsection">
                    <h3>TFIM Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>J (coupling)</label>
                            <input type="number" id="tfim-J" value="-1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>h (field)</label>
                            <input type="number" id="tfim-h" value="0.5" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>coupling_dir</label>
                            <select id="tfim-coupling_dir" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>field_dir</label>
                            <select id="tfim-field_dir" onchange="updatePreview()">
                                <option value="X" selected>X</option>
                                <option value="Y">Y</option>
                                <option value="Z">Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Heisenberg params -->
                <div id="params-heisenberg" class="subsection hidden">
                    <h3>Heisenberg Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Jx</label>
                            <input type="number" id="heis-Jx" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Jy</label>
                            <input type="number" id="heis-Jy" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Jz</label>
                            <input type="number" id="heis-Jz" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>hx</label>
                            <input type="number" id="heis-hx" value="0.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>hy</label>
                            <input type="number" id="heis-hy" value="0.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>hz</label>
                            <input type="number" id="heis-hz" value="0.0" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                </div>

                <!-- Long-range Ising params -->
                <div id="params-long_range_ising" class="subsection hidden">
                    <h3>Long-Range Ising Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>J (coupling)</label>
                            <input type="number" id="lri-J" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>h (field)</label>
                            <input type="number" id="lri-h" value="0.5" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>alpha (power-law exponent)</label>
                            <input type="number" id="lri-alpha" value="1.5" step="0.1" min="0" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>n_exp (FSM exponentials)</label>
                            <input type="number" id="lri-n_exp" value="9" min="1" onchange="updatePreview()">
                            <small class="nexp-hint">Max: 9 (must be &lt; N/2)</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>coupling_dir</label>
                            <select id="lri-coupling_dir" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>field_dir</label>
                            <select id="lri-field_dir" onchange="updatePreview()">
                                <option value="X" selected>X</option>
                                <option value="Y">Y</option>
                                <option value="Z">Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Ising-Dicke params -->
                <div id="params-ising_dickie" class="subsection hidden">
                    <h3>Ising-Dicke Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>J (spin coupling)</label>
                            <input type="number" id="id-J" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>h (spin field)</label>
                            <input type="number" id="id-h" value="0.0" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>omega (boson frequency)</label>
                            <input type="number" id="id-omega" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>g (spin-boson coupling)</label>
                            <input type="number" id="id-g" value="0.2" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>spin_coupling_dir</label>
                            <select id="id-spin_coupling_dir" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>spin_field_dir</label>
                            <select id="id-spin_field_dir" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>boson_coupling_dir</label>
                            <select id="id-boson_coupling_dir" onchange="updatePreview()">
                                <option value="X" selected>X</option>
                                <option value="Y">Y</option>
                                <option value="Z">Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Long-range Ising-Dicke params -->
                <div id="params-long_range_ising_dickie" class="subsection hidden">
                    <h3>Long-Range Ising-Dicke Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>J (spin coupling)</label>
                            <input type="number" id="lrid-J" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>h (spin field)</label>
                            <input type="number" id="lrid-h" value="0.0" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>alpha</label>
                            <input type="number" id="lrid-alpha" value="1.5" step="0.1" min="0" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>n_exp</label>
                            <input type="number" id="lrid-n_exp" value="9" min="1" onchange="updatePreview()">
                            <small class="nexp-hint">Max: 9 (must be &lt; N/2)</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>omega</label>
                            <input type="number" id="lrid-omega" value="1.0" step="0.1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>g</label>
                            <input type="number" id="lrid-g" value="0.2" step="0.1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>spin_coupling_dir</label>
                            <select id="lrid-spin_coupling_dir" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>spin_field_dir</label>
                            <select id="lrid-spin_field_dir" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>boson_coupling_dir</label>
                            <select id="lrid-boson_coupling_dir" onchange="updatePreview()">
                                <option value="X" selected>X</option>
                                <option value="Y">Y</option>
                                <option value="Z">Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATE SECTION -->
            <div class="section">
                <h2>Initial State</h2>
                <div class="form-group">
                    <label>State Type</label>
                    <select id="state-type" onchange="onStateTypeChange()">
                        <option value="random">Random</option>
                        <option value="polarized">Polarized</option>
                        <option value="neel">Néel</option>
                        <option value="kink">Kink</option>
                        <option value="domain">Domain</option>
                    </select>
                </div>

                <!-- Random state params -->
                <div id="state-params-random" class="subsection">
                    <h3>Random State Parameters</h3>
                    <div class="form-group">
                        <label>bond_dim</label>
                        <input type="number" id="state-bond_dim" value="5" min="1" onchange="updatePreview()">
                    </div>
                </div>

                <!-- Polarized state params -->
                <div id="state-params-polarized" class="subsection hidden">
                    <h3>Polarized State Parameters</h3>
                    <div class="form-group hidden" id="group-boson_level-polarized">
                        <label>boson_level</label>
                        <select id="state-boson_level-polarized" onchange="updatePreview()"></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>spin_direction</label>
                            <select id="state-spin_direction-polarized" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-eigenstate-polarized">eigenstate</label>
                            <select id="state-eigenstate-polarized" onchange="updatePreview()"></select>
                        </div>
                    </div>
                </div>

                <!-- Neel state params -->
                <div id="state-params-neel" class="subsection hidden">
                    <h3>Néel State Parameters</h3>
                    <div class="form-group hidden" id="group-boson_level-neel">
                        <label>boson_level</label>
                        <select id="state-boson_level-neel" onchange="updatePreview()"></select>
                    </div>
                    <div class="form-group">
                        <label>spin_direction</label>
                        <select id="state-spin_direction-neel" onchange="updatePreview()">
                            <option value="X">X</option>
                            <option value="Y">Y</option>
                            <option value="Z" selected>Z</option>
                            <option value="Sp">Sp</option>
                            <option value="Sm">Sm</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>even_state</label>
                            <select id="state-even_state-neel" onchange="updatePreview()"></select>
                        </div>
                        <div class="form-group">
                            <label>odd_state</label>
                            <select id="state-odd_state-neel" onchange="updatePreview()"></select>
                        </div>
                    </div>
                </div>

                <!-- Kink state params -->
                <div id="state-params-kink" class="subsection hidden">
                    <h3>Kink State Parameters</h3>
                    <div class="form-group hidden" id="group-boson_level-kink">
                        <label>boson_level</label>
                        <select id="state-boson_level-kink" onchange="updatePreview()"></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>spin_direction</label>
                            <select id="state-spin_direction-kink" onchange="updatePreview()">
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                                <option value="Z" selected>Z</option>
                                <option value="Sp">Sp</option>
                                <option value="Sm">Sm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>position</label>
                            <input type="number" id="state-position-kink" value="10" min="1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>left_state</label>
                            <select id="state-left_state-kink" onchange="updatePreview()"></select>
                        </div>
                        <div class="form-group">
                            <label>right_state</label>
                            <select id="state-right_state-kink" onchange="updatePreview()"></select>
                        </div>
                    </div>
                </div>

                <!-- Domain state params -->
                <div id="state-params-domain" class="subsection hidden">
                    <h3>Domain State Parameters</h3>
                    <div class="form-group hidden" id="group-boson_level-domain">
                        <label>boson_level</label>
                        <select id="state-boson_level-domain" onchange="updatePreview()"></select>
                    </div>
                    <div class="form-group">
                        <label>spin_direction</label>
                        <select id="state-spin_direction-domain" onchange="updatePreview()">
                            <option value="X">X</option>
                            <option value="Y">Y</option>
                            <option value="Z" selected>Z</option>
                            <option value="Sp">Sp</option>
                            <option value="Sm">Sm</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>start_index</label>
                            <input type="number" id="state-start_index-domain" value="10" min="1" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>domain_size</label>
                            <input type="number" id="state-domain_size-domain" value="4" min="1" onchange="updatePreview()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>base_state</label>
                            <select id="state-base_state-domain" onchange="updatePreview()"></select>
                        </div>
                        <div class="form-group">
                            <label>flip_state</label>
                            <select id="state-flip_state-domain" onchange="updatePreview()"></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALGORITHM SECTION -->
            <div class="section">
                <h2>Algorithm</h2>
                <div class="form-group">
                    <label>Algorithm Type</label>
                    <select id="algo-type" onchange="onAlgoTypeChange()">
                        <option value="dmrg">DMRG</option>
                        <option value="tdvp">TDVP</option>
                    </select>
                </div>

                <!-- Solver subsection -->
                <div class="subsection">
                    <h3>Solver</h3>
                    <div id="solver-dmrg">
                        <div class="form-row">
                            <div class="form-group">
                                <label>type</label>
                                <input type="text" id="solver-type-dmrg" value="lanczos" readonly>
                            </div>
                            <div class="form-group">
                                <label>krylov_dim</label>
                                <input type="number" id="solver-krylov_dim-dmrg" value="4" min="1" onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label>max_iter</label>
                                <input type="number" id="solver-max_iter-dmrg" value="14" min="1" onchange="updatePreview()">
                            </div>
                        </div>
                    </div>
                    <div id="solver-tdvp" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label>type</label>
                                <input type="text" id="solver-type-tdvp" value="krylov_exponential" readonly>
                            </div>
                            <div class="form-group">
                                <label>krylov_dim</label>
                                <input type="number" id="solver-krylov_dim-tdvp" value="14" min="1" onchange="updatePreview()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>tol</label>
                                <input type="text" id="solver-tol-tdvp" value="1e-8" onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label>evol_type</label>
                                <select id="solver-evol_type-tdvp" onchange="updatePreview()">
                                    <option value="real" selected>real</option>
                                    <option value="imaginary">imaginary</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Options subsection -->
                <div class="subsection">
                    <h3>Options</h3>
                    <div id="options-dmrg">
                        <div class="form-row">
                            <div class="form-group">
                                <label>chi_max</label>
                                <input type="number" id="options-chi_max-dmrg" value="100" min="1" onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label>cutoff</label>
                                <input type="text" id="options-cutoff-dmrg" value="1e-8" onchange="updatePreview()">
                            </div>
                        </div>
                    </div>
                    <div id="options-tdvp" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label>dt</label>
                                <input type="number" id="options-dt-tdvp" value="0.02" step="0.01" onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label>chi_max</label>
                                <input type="number" id="options-chi_max-tdvp" value="100" min="1" onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label>cutoff</label>
                                <input type="text" id="options-cutoff-tdvp" value="1e-8" onchange="updatePreview()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Run subsection -->
                <div class="subsection">
                    <h3>Run</h3>
                    <div class="form-group">
                        <label>n_sweeps</label>
                        <input type="number" id="run-n_sweeps" value="50" min="1" onchange="updatePreview()">
                    </div>
                </div>
            </div>
            <!-- DESCRIPTION SECTION -->
            <div class="section">
                <h2>Description</h2>
                <div class="form-group">
                    <label>Config Description</label>
                    <textarea id="config-description" rows="3" placeholder="Describe your simulation setup..." onchange="updatePreview()" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                    <small>Optional note about this configuration</small>
                </div>
            </div>
        </div>

        <!-- PREVIEW SECTION -->
        <div class="preview-container">
            <div class="section">
                <div class="preview-header">
                    <h2>Generated Config</h2>
                </div>
                <div id="json-preview"></div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="downloadConfig()">Download config.json</button>
                    <button class="btn btn-secondary" onclick="copyConfig()">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateEigenstateOptions();
            updateBosonLevelOptions();
            validateNexp();
            updatePreview();
        });

        function onSystemTypeChange() {
            const systemType = document.getElementById('system-type').value;
            const isSpinboson = systemType === 'spinboson';
            
            // Toggle N vs N_spins
            document.getElementById('group-N').classList.toggle('hidden', isSpinboson);
            document.getElementById('group-N_spins').classList.toggle('hidden', !isSpinboson);
            document.getElementById('group-nmax').classList.toggle('hidden', !isSpinboson);
            
            // Toggle model options
            const spinModels = document.getElementById('spin-models');
            const spinbosonModels = document.getElementById('spinboson-models');
            
            if (isSpinboson) {
                spinModels.classList.add('hidden');
                spinbosonModels.classList.remove('hidden');
                document.getElementById('model-name').value = 'ising_dickie';
            } else {
                spinModels.classList.remove('hidden');
                spinbosonModels.classList.add('hidden');
                document.getElementById('model-name').value = 'transverse_field_ising';
            }
            
            // Toggle boson_level fields in states
            const states = ['polarized', 'neel', 'kink', 'domain'];
            states.forEach(state => {
                const group = document.getElementById(`group-boson_level-${state}`);
                if (group) group.classList.toggle('hidden', !isSpinboson);
            });
            
            // Update eigenstate label for spinboson
            const label = document.getElementById('label-eigenstate-polarized');
            label.textContent = isSpinboson ? 'spin_eigenstate' : 'eigenstate';
            
            onModelChange();
            updateBosonLevelOptions();
            validateNexp();
            updatePreview();
        }

        function onSpinChange() {
            updateEigenstateOptions();
            updatePreview();
        }

        function onNmaxChange() {
            updateBosonLevelOptions();
            updatePreview();
        }

        function validateNexp() {
            const systemType = document.getElementById('system-type').value;
            const isSpinboson = systemType === 'spinboson';
            
            const N = isSpinboson 
                ? parseInt(document.getElementById('system-N_spins').value)
                : parseInt(document.getElementById('system-N').value);
            
            const maxNexp = Math.floor(N / 2) - 1;
            
            // Update all n_exp inputs
            const nexpInputs = ['lri-n_exp', 'lrid-n_exp'];
            nexpInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.max = maxNexp;
                    if (parseInt(input.value) > maxNexp) {
                        input.value = maxNexp;
                    }
                }
            });
            
            // Update small text hints
            const hints = document.querySelectorAll('.nexp-hint');
            hints.forEach(hint => {
                hint.textContent = `Max: ${maxNexp} (must be < N/2)`;
            });
        }

        function updateEigenstateOptions() {
            const S = parseFloat(document.getElementById('system-S').value);
            const d = Math.round(2 * S + 1);
            
            // All eigenstate selects
            const selects = [
                'state-eigenstate-polarized',
                'state-even_state-neel',
                'state-odd_state-neel',
                'state-left_state-kink',
                'state-right_state-kink',
                'state-base_state-domain',
                'state-flip_state-domain'
            ];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '';
                
                for (let i = 1; i <= d; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }
                
                // Set defaults
                if (id.includes('eigenstate') || id.includes('odd_state') || 
                    id.includes('right_state') || id.includes('flip_state')) {
                    select.value = d; // highest eigenstate
                } else {
                    select.value = 1; // lowest eigenstate
                }
                
                // Restore if valid
                if (currentValue && parseInt(currentValue) <= d) {
                    select.value = currentValue;
                }
            });
        }

        function updateBosonLevelOptions() {
            const nmax = parseInt(document.getElementById('system-nmax').value) || 5;
            
            const selects = [
                'state-boson_level-polarized',
                'state-boson_level-neel',
                'state-boson_level-kink',
                'state-boson_level-domain'
            ];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                select.innerHTML = '';
                for (let i = 0; i <= nmax; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }
                select.value = 0;
            });
        }

        function onModelChange() {
            const model = document.getElementById('model-name').value;
            
            // Hide all param sections
            const allParams = document.querySelectorAll('[id^="params-"]');
            allParams.forEach(el => el.classList.add('hidden'));
            
            // Show selected model params
            const selected = document.getElementById(`params-${model}`);
            if (selected) selected.classList.remove('hidden');
            
            updatePreview();
        }

        function onStateTypeChange() {
            const stateType = document.getElementById('state-type').value;
            
            // Hide all state param sections
            const allParams = document.querySelectorAll('[id^="state-params-"]');
            allParams.forEach(el => el.classList.add('hidden'));
            
            // Show selected state params
            const selected = document.getElementById(`state-params-${stateType}`);
            if (selected) selected.classList.remove('hidden');
            
            updatePreview();
        }

        function onAlgoTypeChange() {
            const algoType = document.getElementById('algo-type').value;
            const isDMRG = algoType === 'dmrg';
            
            document.getElementById('solver-dmrg').classList.toggle('hidden', !isDMRG);
            document.getElementById('solver-tdvp').classList.toggle('hidden', isDMRG);
            document.getElementById('options-dmrg').classList.toggle('hidden', !isDMRG);
            document.getElementById('options-tdvp').classList.toggle('hidden', isDMRG);
            
            updatePreview();
        }

        function buildConfig() {
            const systemType = document.getElementById('system-type').value;
            const isSpinboson = systemType === 'spinboson';
            const S = parseFloat(document.getElementById('system-S').value);
            const localDim = Math.round(2 * S + 1);
            
            // System
            const system = {
                type: systemType,
                dtype: "ComplexF64"
            };
            
            if (isSpinboson) {
                system.N_spins = parseInt(document.getElementById('system-N_spins').value);
                system.nmax = parseInt(document.getElementById('system-nmax').value);
            } else {
                system.N = parseInt(document.getElementById('system-N').value);
            }
            system.S = S;
            
            // Model
            const modelName = document.getElementById('model-name').value;
            const modelDtype = document.getElementById('model-dtype').value;
            
            const model = {
                name: modelName,
                params: {
                    dtype: modelDtype
                }
            };
            
            // Add N or N_spins to model params
            if (isSpinboson) {
                model.params.N_spins = system.N_spins;
                model.params.nmax = system.nmax;
            } else {
                model.params.N = system.N;
            }
            
            // Model-specific params
            if (modelName === 'transverse_field_ising') {
                model.params.J = parseFloat(document.getElementById('tfim-J').value);
                model.params.h = parseFloat(document.getElementById('tfim-h').value);
                model.params.coupling_dir = document.getElementById('tfim-coupling_dir').value;
                model.params.field_dir = document.getElementById('tfim-field_dir').value;
            } else if (modelName === 'heisenberg') {
                model.params.Jx = parseFloat(document.getElementById('heis-Jx').value);
                model.params.Jy = parseFloat(document.getElementById('heis-Jy').value);
                model.params.Jz = parseFloat(document.getElementById('heis-Jz').value);
                model.params.hx = parseFloat(document.getElementById('heis-hx').value);
                model.params.hy = parseFloat(document.getElementById('heis-hy').value);
                model.params.hz = parseFloat(document.getElementById('heis-hz').value);
            } else if (modelName === 'long_range_ising') {
                model.params.J = parseFloat(document.getElementById('lri-J').value);
                model.params.h = parseFloat(document.getElementById('lri-h').value);
                model.params.alpha = parseFloat(document.getElementById('lri-alpha').value);
                model.params.n_exp = parseInt(document.getElementById('lri-n_exp').value);
                model.params.coupling_dir = document.getElementById('lri-coupling_dir').value;
                model.params.field_dir = document.getElementById('lri-field_dir').value;
            } else if (modelName === 'ising_dickie') {
                model.params.J = parseFloat(document.getElementById('id-J').value);
                model.params.h = parseFloat(document.getElementById('id-h').value);
                model.params.omega = parseFloat(document.getElementById('id-omega').value);
                model.params.g = parseFloat(document.getElementById('id-g').value);
                model.params.spin_coupling_dir = document.getElementById('id-spin_coupling_dir').value;
                model.params.spin_field_dir = document.getElementById('id-spin_field_dir').value;
                model.params.boson_coupling_dir = document.getElementById('id-boson_coupling_dir').value;
            } else if (modelName === 'long_range_ising_dickie') {
                model.params.J = parseFloat(document.getElementById('lrid-J').value);
                model.params.h = parseFloat(document.getElementById('lrid-h').value);
                model.params.alpha = parseFloat(document.getElementById('lrid-alpha').value);
                model.params.n_exp = parseInt(document.getElementById('lrid-n_exp').value);
                model.params.omega = parseFloat(document.getElementById('lrid-omega').value);
                model.params.g = parseFloat(document.getElementById('lrid-g').value);
                model.params.spin_coupling_dir = document.getElementById('lrid-spin_coupling_dir').value;
                model.params.spin_field_dir = document.getElementById('lrid-spin_field_dir').value;
                model.params.boson_coupling_dir = document.getElementById('lrid-boson_coupling_dir').value;
            }
            
            // State
            const stateType = document.getElementById('state-type').value;
            const state = {};
            
            if (stateType === 'random') {
                state.type = 'random';
                state.params = {
                    bond_dim: parseInt(document.getElementById('state-bond_dim').value)
                };
            } else {
                state.type = 'prebuilt';
                state.name = stateType;
                state.params = {};
                
                if (isSpinboson) {
                    state.params.boson_level = parseInt(document.getElementById(`state-boson_level-${stateType}`).value);
                }
                
                if (stateType === 'polarized') {
                    state.params.spin_direction = document.getElementById('state-spin_direction-polarized').value;
                    if (isSpinboson) {
                        state.params.spin_eigenstate = parseInt(document.getElementById('state-eigenstate-polarized').value);
                    } else {
                        state.params.eigenstate = parseInt(document.getElementById('state-eigenstate-polarized').value);
                    }
                } else if (stateType === 'neel') {
                    state.params.spin_direction = document.getElementById('state-spin_direction-neel').value;
                    state.params.even_state = parseInt(document.getElementById('state-even_state-neel').value);
                    state.params.odd_state = parseInt(document.getElementById('state-odd_state-neel').value);
                } else if (stateType === 'kink') {
                    state.params.spin_direction = document.getElementById('state-spin_direction-kink').value;
                    state.params.position = parseInt(document.getElementById('state-position-kink').value);
                    state.params.left_state = parseInt(document.getElementById('state-left_state-kink').value);
                    state.params.right_state = parseInt(document.getElementById('state-right_state-kink').value);
                } else if (stateType === 'domain') {
                    state.params.spin_direction = document.getElementById('state-spin_direction-domain').value;
                    state.params.start_index = parseInt(document.getElementById('state-start_index-domain').value);
                    state.params.domain_size = parseInt(document.getElementById('state-domain_size-domain').value);
                    state.params.base_state = parseInt(document.getElementById('state-base_state-domain').value);
                    state.params.flip_state = parseInt(document.getElementById('state-flip_state-domain').value);
                }
            }
            
            // Algorithm
            const algoType = document.getElementById('algo-type').value;
            const algorithm = {
                type: algoType
            };
            
            if (algoType === 'dmrg') {
                algorithm.solver = {
                    type: 'lanczos',
                    krylov_dim: parseInt(document.getElementById('solver-krylov_dim-dmrg').value),
                    max_iter: parseInt(document.getElementById('solver-max_iter-dmrg').value)
                };
                algorithm.options = {
                    chi_max: parseInt(document.getElementById('options-chi_max-dmrg').value),
                    cutoff: parseFloat(document.getElementById('options-cutoff-dmrg').value),
                    local_dim: localDim
                };
            } else {
                algorithm.solver = {
                    type: 'krylov_exponential',
                    krylov_dim: parseInt(document.getElementById('solver-krylov_dim-tdvp').value),
                    tol: parseFloat(document.getElementById('solver-tol-tdvp').value),
                    evol_type: document.getElementById('solver-evol_type-tdvp').value
                };
                algorithm.options = {
                    dt: parseFloat(document.getElementById('options-dt-tdvp').value),
                    chi_max: parseInt(document.getElementById('options-chi_max-tdvp').value),
                    cutoff: parseFloat(document.getElementById('options-cutoff-tdvp').value),
                    local_dim: localDim
                };
            }
            
            algorithm.run = {
                n_sweeps: parseInt(document.getElementById('run-n_sweeps').value)
            };
            
            // Description
            const description = document.getElementById('config-description').value.trim();
            
            const config = { system, model, state, algorithm };
            if (description) {
                config.description = description;
            }
            
            return config;
        }

        function updatePreview() {
            const config = buildConfig();
            const json = JSON.stringify(config, null, 2);
            document.getElementById('json-preview').textContent = json;
        }

        function downloadConfig() {
            const config = buildConfig();
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyConfig() {
            const config = buildConfig();
            const json = JSON.stringify(config, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                alert('Config copied to clipboard!');
            });
        }
    </script>
</body>
</html>
